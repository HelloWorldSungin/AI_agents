{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Project State Schema",
  "description": "Central state management for multi-agent projects",
  "version": "1.0.0",
  "type": "object",
  "required": ["project_id", "updated_at", "active_tasks", "agent_states"],
  "properties": {
    "project_id": {
      "type": "string",
      "description": "Unique project identifier"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "Last update timestamp"
    },
    "current_sprint": {
      "type": "string",
      "description": "Current sprint identifier (e.g., 'sprint-5')"
    },
    "active_tasks": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/task"
      },
      "description": "Currently active tasks"
    },
    "completed_tasks": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/completedTask"
      },
      "description": "Recently completed tasks"
    },
    "agent_states": {
      "type": "object",
      "patternProperties": {
        "^[a-z]+-[a-z]+-[0-9]{3}$": {
          "$ref": "#/definitions/agentState"
        }
      },
      "description": "Current state of each agent"
    },
    "shared_resources": {
      "type": "object",
      "patternProperties": {
        ".*": {
          "$ref": "#/definitions/resourceLock"
        }
      },
      "description": "Shared resources and their lock status"
    },
    "integration_points": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/integrationPoint"
      },
      "description": "Defined integration points between components"
    },
    "metrics": {
      "$ref": "#/definitions/projectMetrics"
    }
  },

  "definitions": {
    "task": {
      "type": "object",
      "required": ["task_id", "title", "assigned_to", "status", "priority"],
      "properties": {
        "task_id": {
          "type": "string",
          "pattern": "^TASK-[0-9]{3,}$"
        },
        "title": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "assigned_to": {
          "type": "string",
          "pattern": "^[a-z]+-[a-z]+-[0-9]{3}$"
        },
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "blocked", "review", "completed", "failed"]
        },
        "progress": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "priority": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "branch": {
          "type": "string",
          "description": "Git branch for this task"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^TASK-[0-9]{3,}$"
          }
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "estimated_completion": {
          "type": "string",
          "format": "date-time"
        },
        "blockers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "description": { "type": "string" },
              "severity": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              },
              "reported_at": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      }
    },

    "completedTask": {
      "type": "object",
      "required": ["task_id", "completed_at", "completed_by"],
      "properties": {
        "task_id": {
          "type": "string",
          "pattern": "^TASK-[0-9]{3,}$"
        },
        "title": {
          "type": "string"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_by": {
          "type": "string",
          "pattern": "^[a-z]+-[a-z]+-[0-9]{3}$"
        },
        "time_taken": {
          "type": "string",
          "description": "Human-readable duration (e.g., '6 hours', '2 days')"
        },
        "deliverables": {
          "type": "object",
          "properties": {
            "files_modified": {
              "type": "array",
              "items": { "type": "string" }
            },
            "commits": {
              "type": "array",
              "items": { "type": "string" }
            },
            "tests_added": {
              "type": "integer"
            },
            "test_coverage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            }
          }
        }
      }
    },

    "agentState": {
      "type": "object",
      "required": ["status", "last_update"],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["active", "idle", "blocked", "offline"]
        },
        "current_task": {
          "type": "string",
          "pattern": "^TASK-[0-9]{3,}$"
        },
        "branch": {
          "type": "string",
          "description": "Current git branch"
        },
        "last_update": {
          "type": "string",
          "format": "date-time"
        },
        "last_commit": {
          "type": "string",
          "description": "Last commit hash"
        },
        "working_files": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files currently being worked on"
        },
        "context_usage": {
          "type": "integer",
          "description": "Current context window usage in tokens"
        },
        "blocked": {
          "type": "boolean"
        },
        "blocker_reason": {
          "type": "string"
        },
        "health": {
          "type": "object",
          "properties": {
            "last_heartbeat": {
              "type": "string",
              "format": "date-time"
            },
            "error_count": {
              "type": "integer"
            },
            "last_error": {
              "type": "string"
            }
          }
        }
      }
    },

    "resourceLock": {
      "type": "object",
      "properties": {
        "owner": {
          "type": "string",
          "pattern": "^[a-z]+-[a-z]+-[0-9]{3}$",
          "description": "Agent that owns the resource"
        },
        "lock_status": {
          "type": "string",
          "enum": ["locked", "unlocked", "pending"]
        },
        "locked_at": {
          "type": "string",
          "format": "date-time"
        },
        "last_modified": {
          "type": "string",
          "format": "date-time"
        },
        "pending_requests": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "agent_id": {
                "type": "string",
                "pattern": "^[a-z]+-[a-z]+-[0-9]{3}$"
              },
              "requested_at": {
                "type": "string",
                "format": "date-time"
              },
              "priority": {
                "type": "string",
                "enum": ["low", "medium", "high", "critical"]
              }
            }
          }
        }
      }
    },

    "integrationPoint": {
      "type": "object",
      "required": ["name", "status", "stakeholders"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the integration point (e.g., 'Auth API')"
        },
        "type": {
          "type": "string",
          "enum": ["api", "database", "message_queue", "shared_library", "interface"]
        },
        "status": {
          "type": "string",
          "enum": ["proposed", "defined", "implemented", "tested", "deployed"]
        },
        "stakeholders": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z]+-[a-z]+-[0-9]{3}$"
          },
          "description": "Agents involved in this integration"
        },
        "contract_file": {
          "type": "string",
          "description": "Path to contract/interface definition"
        },
        "last_updated": {
          "type": "string",
          "format": "date-time"
        },
        "version": {
          "type": "string",
          "description": "Version of the integration contract"
        },
        "breaking_changes": {
          "type": "boolean",
          "description": "Whether there are breaking changes pending"
        }
      }
    },

    "projectMetrics": {
      "type": "object",
      "properties": {
        "total_tasks": {
          "type": "integer"
        },
        "completed_tasks": {
          "type": "integer"
        },
        "in_progress_tasks": {
          "type": "integer"
        },
        "blocked_tasks": {
          "type": "integer"
        },
        "average_completion_time": {
          "type": "string",
          "description": "Average time to complete a task (e.g., '5.2 hours')"
        },
        "test_pass_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Percentage as decimal (0.96 = 96%)"
        },
        "code_review_turnaround": {
          "type": "string",
          "description": "Average code review time (e.g., '2.3 hours')"
        },
        "deployment_frequency": {
          "type": "string",
          "description": "How often deployments happen (e.g., 'daily', 'weekly')"
        },
        "bug_density": {
          "type": "number",
          "description": "Bugs per thousand lines of code"
        },
        "velocity": {
          "type": "number",
          "description": "Tasks completed per sprint"
        }
      }
    }
  }
}
